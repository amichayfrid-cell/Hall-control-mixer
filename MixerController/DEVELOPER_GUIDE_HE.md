# מדריך למפתח - מערכת בקרת מיקסר (MixerController)

מסמך זה מרכז את כל המידע הטכני, החומרתי והתוכנתי עבור פרויקט בקרת המיקסר. המערכת מבוססת על בקר **ESP32-S3** עם מסך מגע, המפקד על בקר נוסף (MixerBody) באמצעות תקשורת RS485 פרוטוקול JSON.

---

## 1. חומרה (Hardware)

### בקר התצוגה (MixerController)
*   **לוח פיתוח:** Waveshare ESP32-S3-Touch-LCD-4.3B
*   **מעבד:** ESP32-S3 (Dual Core, 240MHz)
*   **זיכרון:** 16MB Flash / 8MB PSRAM (Octal/OPI Mode)
*   **מסך:** 4.3 אינץ', רזולוציה 800x480, ממשק RGB.
*   **מגע:** מבוסס בקר GT911 (ממשק I2C).
*   **הרחבת I/O:** שבב CH422G (משמש לשליטה על התאורה האחורית ואיפוס המגע).

### מיפוי פינים קריטי (Pinout)

#### תקשורת RS485 (בין המסך לבקר הגוף)
| פונקציה | פין ב-ESP32 (מסך) | הערות |
| :--- | :--- | :--- |
| **TX (שידור)** | **GPIO 15** | מחובר למשדר ה-RS485 המובנה בלוח |
| **RX (קליטה)** | **GPIO 16** | מחובר למקלט ה-RS485 המובנה בלוח |
| **DE (כיוון)** | אוטומטי | הלוח של Waveshare מכיל מעגל אוטומטי, אין צורך בפין שליטה. |

> **הערה לחיבור:** יש לחבר את יציאות ה-A וה-B במחבר ה-RS485 של המסך ליציאות התואמות (A ל-A, ו-B ל-B) בבקר השני.

#### תצוגה (RGB Display 800x480)
הגדרות אלו מוגדרות ב-`lib/BSP/bsp.h` וב-`bsp.cpp`.
*   **PCLK (שעון):** GPIO 7
*   **DE (Data Enable):** GPIO 5
*   **VSYNC:** GPIO 3
*   **HSYNC:** GPIO 46
*   **Bus:** 16-bit RGB (R0-R4, G0-G5, B0-B4).

#### מגע (Touch) ותאורה
*   **I2C SDA:** GPIO 8
*   **I2C SCL:** GPIO 9
*   **GT911 INT:** GPIO 4
*   **Backlight:** נשלט ע"י CH422G (כתובת I2C 0x24).

---

## 2. הגדרות תצוגה קריטיות (Display Timings)

**שים לב:** זהו החלק הרגיש ביותר במערכת. המסך הזה רגיש מאוד לתזמונים.
לאחר ניסוי וטעייה מרובים, הגענו לנוסחה היציבה הבאה ("Stable Rock Config"):

*   **Pixel Clock (PCLK):** 12MHz (המהירות הורדה מ-16MHz לטובת יציבות מוחלטת ומניעת ריצודים).
*   **PCLK Phase:** Inverted (Active Negative = 1).
*   **Bounce Buffer:** Enabled (חובה לביצועים תקינים).
*   **Porches (תזמונים):**
    *   HSYNC: Front=8, Pulse=4, Back=8
    *   VSYNC: Front=8, Pulse=4, Back=8

הקוד הרלוונטי נמצא בקובץ `d:\MIXER\MixerController\lib\BSP\bsp.cpp`.
**אין לשנות ערכים אלו אלא אם כן אתם יודעים בדיוק מה אתם עושים.**

---

## 3. ארכיטקטורת תוכנה (Software)

הפרויקט בנוי ב-PlatformIO על גבי Arduino Framework.

### מבנה הקבצים
*   `src/main.cpp`: הלולאה הראשית, אתחול המערכת וטיפול באירועים.
*   `src/app_data.cpp`: "המוח" של האפליקציה. מנהל את הנתונים (ווליום, מצבי ממסר), שומר לזיכרון (Preferences) ושולח ל-RS485.
*   `src/ui/`: קבצים שנוצרו אוטומטית ע"י SquareLine Studio (SLS).
    *   `ui.c/h`: אתחול הגרפיקה.
    *   `screens/`: הגדרת המסכים והווידג'טים.
*   `src/ui_events_impl.cpp`: המימוש "שלנו" לאירועים הגרפיים (מה קורה כשלוחצים על כפתור).
*   `lib/BSP/`: חבילת תמיכה בחומרה (דרייברים למסך, למגע ול-CH422G).

### ניהול מצבים (State Management)
המחלקה `AppDataManager` (ב-`app_data.h`) מחזיקה את המצב הנוכחי:
1.  **Music Volume** (0-100)
2.  **Mic Volume** (0-100)
3.  **Main Fader** (0-100)
4.  **Relays State** (Music / Mic)

**שמירה בזיכרון:**
כל שינוי נשמר מיידית ל-NVS (Non-Volatile Storage) באמצעות ספריית `Preferences`.
בעת עליית המערכת, הפונקציה `syncUI()` נקראת כדי לעדכן את הפיידרים והכפתורים למצב האחרון שנשמר.

---

## 4. פרוטוקול תקשורת (RS485 Protocol)

המערכת משדרת נתונים בפורמט **JSON**.
בכל שינוי (הזזת פיידר, לחיצה על כפתור) נשלחת הפקודה הבאה לפורט הטורי `Serial1`.

### מבנה ההודעה
```json
{"mv":80, "cv":50, "mr":1, "cr":1}
```

### מקרא (Keys)
*   **`mv`** (Music Volume): ערך מספרי (תוצאה של ווליום ערוץ * פיידר ראשי).
*   **`cv`** (Channel/Mic Volume): ערך מספרי (ווליום מיקרופון * פיידר ראשי).
*   **`mr`** (Music Relay): `1` (פעיל/מחובר), `0` (כבוי).
*   **`cr`** (Channel/Mic Relay): `1` (פעיל/מחובר), `0` (כבוי).

### בקשת סנכרון (Handshake)
כאשר הבקר השני (MixerBody) נדלק, הוא שולח את התו `?` (או פקודת `{"cmd":"get"}`).
בתגובה, המסך שולח מיידית את הסטטוס המלא (JSON).
ניתן לבדוק זאת על ידי שליחת `?` דרך ה-Serial Monitor של המחשב.

---

## 5. הערות למפתח UI (גרפיקה)

הממשק עוצב ב-**SquareLine Studio**.
אם נדרש שינוי גרפי:
1.  יש לייצא מחדש את הקבצים מ-SLS.
2.  **שים לב:** בקובץ `ui_Screen1.c`, יש לבצע **תיקון ידני** לאחר כל ייצוא:
    *   יש **לאפס** את ה-Padding (`pad_left`) של הפיידרים (`ui_Slider1`, `ui_Slider2`) ל-`0` כדי שלא ייווצר רווח במילוי.
    *   יש **להוסיף** Padding של `15` לאייקונים (`ui_Image15`, `ui_Image12`) כדי שלא יידבקו לקצה.

---

**נכתב ע"י Antigravity AI**
תאריך: 12/01/2026
עבור: פרויקט בקרת מיקסר RS485
